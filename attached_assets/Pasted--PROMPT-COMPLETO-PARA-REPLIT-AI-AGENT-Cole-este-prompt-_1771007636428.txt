# üöÄ PROMPT COMPLETO PARA REPLIT AI AGENT

Cole este prompt no Replit AI Agent para implementar TUDO:

---

Preciso implementar o sistema completo de atendentes e etiquetas no frontend. Aqui est√£o TODOS os arquivos necess√°rios:

## 1. ATUALIZAR: src/utils/horarioComercial.ts

Substitua o arquivo existente por:

```typescript
export interface Feriado {
  data: string;
  nome: string;
}

export const feriados2026: Feriado[] = [
  { data: '2026-01-01', nome: 'Confraterniza√ß√£o Universal' },
  { data: '2026-02-16', nome: 'Carnaval' },
  { data: '2026-02-17', nome: 'Carnaval' },
  { data: '2026-04-03', nome: 'Sexta-feira Santa' },
  { data: '2026-04-21', nome: 'Tiradentes' },
  { data: '2026-05-01', nome: 'Dia do Trabalho' },
  { data: '2026-06-04', nome: 'Corpus Christi' },
  { data: '2026-09-07', nome: 'Independ√™ncia do Brasil' },
  { data: '2026-10-12', nome: 'Nossa Senhora Aparecida' },
  { data: '2026-11-02', nome: 'Finados' },
  { data: '2026-11-15', nome: 'Proclama√ß√£o da Rep√∫blica' },
  { data: '2026-12-25', nome: 'Natal' }
];

export const horarioComercial = {
  segunda: { inicio: '08:00', fim: '17:00', almoco: { inicio: '13:00', fim: '14:30' } },
  terca: { inicio: '08:00', fim: '17:00', almoco: { inicio: '13:00', fim: '14:30' } },
  quarta: { inicio: '08:00', fim: '17:00', almoco: { inicio: '13:00', fim: '14:30' } },
  quinta: { inicio: '08:00', fim: '17:00', almoco: { inicio: '13:00', fim: '14:30' } },
  sexta: { inicio: '08:00', fim: '17:00', almoco: { inicio: '13:00', fim: '14:30' } },
  sabado: { inicio: '08:30', fim: '12:30', almoco: null },
  domingo: null
};

export const verificarHorarioComercial = (): {
  dentroHorario: boolean;
  motivo: 'horario' | 'feriado' | 'domingo' | 'almoco' | null;
  mensagem?: string;
} => {
  const agora = new Date();
  const diaSemana = agora.getDay();
  const horaAtual = agora.getHours() * 100 + agora.getMinutes();
  const dataHoje = agora.toISOString().split('T')[0];

  const feriado = feriados2026.find(f => f.data === dataHoje);
  if (feriado) {
    return { 
      dentroHorario: false, 
      motivo: 'feriado',
      mensagem: `Hoje √© feriado: ${feriado.nome}`
    };
  }

  if (diaSemana === 0) {
    return { 
      dentroHorario: false, 
      motivo: 'domingo',
      mensagem: 'Fechado aos domingos'
    };
  }

  const diasSemana = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
  const diaChave = diasSemana[diaSemana] as keyof typeof horarioComercial;
  const horario = horarioComercial[diaChave];

  if (!horario) {
    return { 
      dentroHorario: false, 
      motivo: 'domingo',
      mensagem: 'Fechado aos domingos'
    };
  }

  if (horario.almoco) {
    const [almocoInicioH, almocoInicioM] = horario.almoco.inicio.split(':').map(Number);
    const [almocoFimH, almocoFimM] = horario.almoco.fim.split(':').map(Number);
    const almocoInicio = almocoInicioH * 100 + almocoInicioM;
    const almocoFim = almocoFimH * 100 + almocoFimM;
    
    if (horaAtual >= almocoInicio && horaAtual <= almocoFim) {
      return {
        dentroHorario: false,
        motivo: 'almoco',
        mensagem: `Hor√°rio de almo√ßo: ${horario.almoco.inicio} √†s ${horario.almoco.fim}`
      };
    }
  }

  const [inicioH, inicioM] = horario.inicio.split(':').map(Number);
  const [fimH, fimM] = horario.fim.split(':').map(Number);
  const horaInicio = inicioH * 100 + inicioM;
  const horaFim = fimH * 100 + fimM;

  if (horaAtual < horaInicio || horaAtual > horaFim) {
    return { 
      dentroHorario: false, 
      motivo: 'horario',
      mensagem: `Hor√°rio de atendimento: ${horario.inicio} √†s ${horario.fim}`
    };
  }

  return { dentroHorario: true, motivo: null };
};

export const getMensagemForaHorario = (): string => {
  const status = verificarHorarioComercial();
  
  if (status.dentroHorario) {
    return 'Estamos em hor√°rio de atendimento';
  }

  switch (status.motivo) {
    case 'feriado':
      return status.mensagem || 'Fechado - Feriado';
    case 'domingo':
      return 'Fechado aos domingos';
    case 'almoco':
      return 'Hor√°rio de almo√ßo - IA respondendo';
    case 'horario':
      return status.mensagem || 'Fora do hor√°rio de atendimento';
    default:
      return 'Fora do hor√°rio de atendimento';
  }
};
```

## 2. CRIAR: src/components/EtiquetasManager.tsx

```typescript
import React, { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { Tag, X, Plus } from 'lucide-react';

interface Etiqueta {
  id: string;
  nome: string;
  cor: string;
  tipo: 'funil' | 'produto' | 'status';
}

interface EtiquetasManagerProps {
  conversaId: string;
}

export const EtiquetasManager: React.FC<EtiquetasManagerProps> = ({ conversaId }) => {
  const [etiquetas, setEtiquetas] = useState<Etiqueta[]>([]);
  const [etiquetasAplicadas, setEtiquetasAplicadas] = useState<Etiqueta[]>([]);
  const [mostrarSeletor, setMostrarSeletor] = useState(false);
  const [tipoSelecionado, setTipoSelecionado] = useState<'funil' | 'produto' | 'status'>('funil');

  useEffect(() => {
    const fetchEtiquetas = async () => {
      const { data } = await supabase
        .from('etiquetas')
        .select('*')
        .eq('ativo', true)
        .order('tipo, ordem');
      
      if (data) setEtiquetas(data);
    };

    fetchEtiquetas();
  }, []);

  useEffect(() => {
    const fetchEtiquetasAplicadas = async () => {
      const { data } = await supabase
        .from('conversas_etiquetas')
        .select(`
          etiqueta_id,
          etiquetas (
            id,
            nome,
            cor,
            tipo
          )
        `)
        .eq('conversa_id', conversaId);
      
      if (data) {
        const etiquetasData = data.map(item => item.etiquetas).filter(Boolean);
        setEtiquetasAplicadas(etiquetasData as Etiqueta[]);
      }
    };

    fetchEtiquetasAplicadas();

    const channel = supabase
      .channel(`etiquetas-${conversaId}`)
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'conversas_etiquetas',
          filter: `conversa_id=eq.${conversaId}`
        },
        () => fetchEtiquetasAplicadas()
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [conversaId]);

  const adicionarEtiqueta = async (etiquetaId: string) => {
    const { error } = await supabase
      .from('conversas_etiquetas')
      .insert({
        conversa_id: conversaId,
        etiqueta_id: etiquetaId
      });

    if (!error) {
      setMostrarSeletor(false);
    }
  };

  const removerEtiqueta = async (etiquetaId: string) => {
    await supabase
      .from('conversas_etiquetas')
      .delete()
      .eq('conversa_id', conversaId)
      .eq('etiqueta_id', etiquetaId);
  };

  const etiquetasPorTipo = etiquetas.filter(e => e.tipo === tipoSelecionado);
  const etiquetasAplicadasIds = etiquetasAplicadas.map(e => e.id);

  return (
    <div className="space-y-2">
      <div className="flex flex-wrap gap-2">
        {etiquetasAplicadas.map(etiqueta => (
          <div
            key={etiqueta.id}
            className="flex items-center gap-1 px-2 py-1 rounded text-xs font-medium text-white"
            style={{ backgroundColor: etiqueta.cor }}
          >
            <Tag className="w-3 h-3" />
            {etiqueta.nome}
            <button
              onClick={() => removerEtiqueta(etiqueta.id)}
              className="hover:bg-white/20 rounded p-0.5"
            >
              <X className="w-3 h-3" />
            </button>
          </div>
        ))}
        
        <button
          onClick={() => setMostrarSeletor(!mostrarSeletor)}
          className="flex items-center gap-1 px-2 py-1 border border-gray-300 rounded text-xs hover:bg-gray-50"
        >
          <Plus className="w-3 h-3" />
          Adicionar
        </button>
      </div>

      {mostrarSeletor && (
        <div className="border rounded-lg p-3 bg-white shadow-lg">
          <div className="flex gap-2 mb-3 border-b">
            <button
              onClick={() => setTipoSelecionado('funil')}
              className={`px-3 py-1 text-sm font-medium ${
                tipoSelecionado === 'funil'
                  ? 'border-b-2 border-blue-500 text-blue-600'
                  : 'text-gray-500'
              }`}
            >
              Funil
            </button>
            <button
              onClick={() => setTipoSelecionado('produto')}
              className={`px-3 py-1 text-sm font-medium ${
                tipoSelecionado === 'produto'
                  ? 'border-b-2 border-blue-500 text-blue-600'
                  : 'text-gray-500'
              }`}
            >
              Produtos
            </button>
            <button
              onClick={() => setTipoSelecionado('status')}
              className={`px-3 py-1 text-sm font-medium ${
                tipoSelecionado === 'status'
                  ? 'border-b-2 border-blue-500 text-blue-600'
                  : 'text-gray-500'
              }`}
            >
              Status
            </button>
          </div>

          <div className="grid grid-cols-2 gap-2">
            {etiquetasPorTipo.map(etiqueta => {
              const jaAplicada = etiquetasAplicadasIds.includes(etiqueta.id);
              
              return (
                <button
                  key={etiqueta.id}
                  onClick={() => !jaAplicada && adicionarEtiqueta(etiqueta.id)}
                  disabled={jaAplicada}
                  className={`flex items-center gap-2 px-3 py-2 rounded text-sm font-medium transition-colors ${
                    jaAplicada
                      ? 'opacity-50 cursor-not-allowed'
                      : 'hover:opacity-80'
                  }`}
                  style={{ 
                    backgroundColor: etiqueta.cor,
                    color: 'white'
                  }}
                >
                  <Tag className="w-4 h-4" />
                  {etiqueta.nome}
                </button>
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
};
```

## 3. CRIAR: src/components/AtendenteStatus.tsx

```typescript
import React, { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { User, Circle } from 'lucide-react';

interface Atendente {
  id: string;
  nome: string;
  email: string;
  online: boolean;
  status: 'ativo' | 'ausente' | 'offline';
  conversas_ativas: number;
  limite_conversas: number;
}

interface AtendenteStatusProps {
  atendenteEmail: string;
}

export const AtendenteStatus: React.FC<AtendenteStatusProps> = ({ atendenteEmail }) => {
  const [atendente, setAtendente] = useState<Atendente | null>(null);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    const fetchAtendente = async () => {
      const { data } = await supabase
        .from('atendentes')
        .select('*')
        .eq('email', atendenteEmail)
        .single();
      
      if (data) setAtendente(data);
    };

    fetchAtendente();

    const channel = supabase
      .channel('atendente-status')
      .on(
        'postgres_changes',
        {
          event: 'UPDATE',
          schema: 'public',
          table: 'atendentes',
          filter: `email=eq.${atendenteEmail}`
        },
        (payload) => {
          if (payload.new) {
            setAtendente(payload.new as Atendente);
          }
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [atendenteEmail]);

  useEffect(() => {
    if (!atendente) return;

    const marcarOnline = async () => {
      await supabase
        .from('atendentes')
        .update({
          online: true,
          status: 'ativo',
          ultima_atividade: new Date().toISOString()
        })
        .eq('email', atendenteEmail);
    };

    marcarOnline();

    const interval = setInterval(() => {
      supabase
        .from('atendentes')
        .update({
          ultima_atividade: new Date().toISOString()
        })
        .eq('email', atendenteEmail);
    }, 30000);

    const marcarOffline = async () => {
      await supabase
        .from('atendentes')
        .update({
          online: false,
          status: 'offline'
        })
        .eq('email', atendenteEmail);
    };

    window.addEventListener('beforeunload', marcarOffline);

    return () => {
      clearInterval(interval);
      window.removeEventListener('beforeunload', marcarOffline);
      marcarOffline();
    };
  }, [atendente, atendenteEmail]);

  const alternarStatus = async (novoStatus: 'ativo' | 'ausente' | 'offline') => {
    if (!atendente) return;

    setLoading(true);
    try {
      await supabase
        .from('atendentes')
        .update({
          status: novoStatus,
          online: novoStatus !== 'offline'
        })
        .eq('id', atendente.id);
    } catch (error) {
      console.error('Erro ao alterar status:', error);
    } finally {
      setLoading(false);
    }
  };

  if (!atendente) return null;

  const getStatusColor = () => {
    if (!atendente.online) return 'bg-gray-400';
    if (atendente.status === 'ativo') return 'bg-green-500';
    if (atendente.status === 'ausente') return 'bg-yellow-500';
    return 'bg-gray-400';
  };

  const getStatusText = () => {
    if (!atendente.online) return 'Offline';
    if (atendente.status === 'ativo') return 'Dispon√≠vel';
    if (atendente.status === 'ausente') return 'Ausente';
    return 'Offline';
  };

  return (
    <div className="flex items-center gap-3 p-3 bg-white border rounded-lg">
      <div className="relative">
        <User className="w-10 h-10 p-2 bg-blue-100 text-blue-600 rounded-full" />
        <div className={`absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white ${getStatusColor()}`} />
      </div>

      <div className="flex-1">
        <div className="font-semibold text-sm">{atendente.nome}</div>
        <div className="flex items-center gap-2 text-xs text-gray-500">
          <Circle className={`w-2 h-2 ${getStatusColor()}`} />
          {getStatusText()}
        </div>
      </div>

      <div className="text-right">
        <div className="text-sm font-medium text-gray-700">
          {atendente.conversas_ativas}/{atendente.limite_conversas}
        </div>
        <div className="text-xs text-gray-500">conversas</div>
      </div>

      <div className="flex gap-1">
        <button
          onClick={() => alternarStatus('ativo')}
          disabled={loading || atendente.status === 'ativo'}
          className={`px-2 py-1 text-xs rounded ${
            atendente.status === 'ativo'
              ? 'bg-green-100 text-green-700'
              : 'bg-gray-100 text-gray-600 hover:bg-green-50'
          } disabled:opacity-50`}
        >
          Ativo
        </button>
        <button
          onClick={() => alternarStatus('ausente')}
          disabled={loading || atendente.status === 'ausente'}
          className={`px-2 py-1 text-xs rounded ${
            atendente.status === 'ausente'
              ? 'bg-yellow-100 text-yellow-700'
              : 'bg-gray-100 text-gray-600 hover:bg-yellow-50'
          } disabled:opacity-50`}
        >
          Ausente
        </button>
      </div>
    </div>
  );
};
```

## 4. CRIAR: src/hooks/useConversasPorAtendente.ts

```typescript
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';

interface UseConversasPorAtendenteProps {
  atendenteEmail: string;
  filtroStatus?: 'todas' | 'ativa' | 'fechada' | 'arquivada';
}

export const useConversasPorAtendente = ({ 
  atendenteEmail, 
  filtroStatus = 'ativa' 
}: UseConversasPorAtendenteProps) => {
  const [conversas, setConversas] = useState([]);
  const [loading, setLoading] = useState(true);
  const [atendenteId, setAtendenteId] = useState<string | null>(null);

  useEffect(() => {
    const fetchAtendenteId = async () => {
      const { data } = await supabase
        .from('atendentes')
        .select('id')
        .eq('email', atendenteEmail)
        .single();
      
      if (data) setAtendenteId(data.id);
    };

    fetchAtendenteId();
  }, [atendenteEmail]);

  useEffect(() => {
    if (!atendenteId) return;

    const fetchConversas = async () => {
      setLoading(true);
      
      let query = supabase
        .from('conversas')
        .select(`
          *,
          clientes (
            id,
            nome,
            whatsapp,
            email
          )
        `)
        .eq('atendente_id', atendenteId);

      if (filtroStatus !== 'todas') {
        query = query.eq('status', filtroStatus);
      }

      const { data, error } = await query
        .order('ultima_mensagem_em', { ascending: false });

      if (data && !error) {
        setConversas(data);
      }
      
      setLoading(false);
    };

    fetchConversas();

    const channel = supabase
      .channel(`conversas-atendente-${atendenteId}`)
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'conversas',
          filter: `atendente_id=eq.${atendenteId}`
        },
        () => fetchConversas()
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [atendenteId, filtroStatus]);

  return { conversas, loading, atendenteId };
};
```

## 5. ATUALIZAR IAToggle (adicionar modo almo√ßo)

No arquivo `src/components/IAToggle.tsx` existente, atualize a fun√ß√£o getModoTexto():

```typescript
const getModoTexto = () => {
  if (iaStatus.iaModo === 'manual') return 'Manual';
  if (iaStatus.iaModo === 'horario') return 'Auto - Fora de hor√°rio';
  if (iaStatus.iaModo === 'feriado') return 'Auto - Feriado';
  if (iaStatus.iaModo === 'domingo') return 'Auto - Domingo';
  if (iaStatus.iaModo === 'almoco') return 'Auto - Hor√°rio de almo√ßo';
  return '';
};
```

## 6. INTEGRA√á√ÉO NO CHATWINDOW

No componente onde voc√™ mostra a conversa (ChatWindow, ConversationView, etc), adicione:

```typescript
import { EtiquetasManager } from '@/components/EtiquetasManager';
import { IAToggle } from '@/components/IAToggle';
import { AtendenteStatus } from '@/components/AtendenteStatus';
import { useConversasPorAtendente } from '@/hooks/useConversasPorAtendente';

// No componente:
const { conversas, loading } = useConversasPorAtendente({
  atendenteEmail: user.email,
  filtroStatus: 'ativa'
});

// No header da p√°gina principal (fora do chat):
<AtendenteStatus atendenteEmail={user.email} />

// No header da conversa individual:
<div className="border-b p-4 bg-white">
  <IAToggle conversaId={conversaAtual.id} />
  <div className="mt-3">
    <EtiquetasManager conversaId={conversaAtual.id} />
  </div>
</div>

// Usar conversas do hook ao inv√©s da query direta:
{loading ? (
  <div>Carregando...</div>
) : (
  conversas.map(conversa => (
    <ConversaCard key={conversa.id} conversa={conversa} />
  ))
)}
```

Por favor, implemente essas mudan√ßas mantendo a estrutura existente do projeto e os imports corretos de acordo com o seu setup atual.

---

FIM DO PROMPT