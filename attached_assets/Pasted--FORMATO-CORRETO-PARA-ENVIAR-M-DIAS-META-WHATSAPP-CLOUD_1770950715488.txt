# üì± FORMATO CORRETO PARA ENVIAR M√çDIAS - META WHATSAPP CLOUD API

---

## üéØ FORMATOS OFICIAIS SUPORTADOS

### **üì∏ IMAGENS**
- **Formatos:** JPEG, PNG
- **Tamanho m√°ximo:** 5 MB
- **Recomendado:** JPEG comprimido

### **üé• V√çDEOS**
- **Formatos:** MP4, 3GPP
- **Codecs:** H.264, MPEG-4
- **Tamanho m√°ximo:** 16 MB
- **Dura√ß√£o m√°xima:** Sem limite oficial

### **üéµ √ÅUDIOS**
- **Formatos:** AAC, MP4 (√°udio), MPEG, AMR, OGG (Opus codec)
- **Tamanho m√°ximo:** 16 MB
- **‚ö†Ô∏è IMPORTANTE:** WhatsApp prefere **OGG com codec Opus**

### **üìÑ DOCUMENTOS**
- **Formatos:** PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, TXT
- **Tamanho m√°ximo:** 100 MB

---

## üîß SOLU√á√ÉO PARA √ÅUDIO: CONVERTER WEBM ‚Üí OGG

Vamos configurar a convers√£o autom√°tica no frontend!

---

## üìù C√ìDIGO PARA CONVERS√ÉO DE √ÅUDIO NO REPLIT

### **1. Instalar depend√™ncias:**

```bash
npm install lamejs
```

### **2. Fun√ß√£o de convers√£o (adicionar no frontend):**

```typescript
// src/utils/audioConverter.ts

import lamejs from 'lamejs';

export async function convertWebMToMP3(webmBlob: Blob): Promise<Blob> {
  // Converter WebM para WAV primeiro
  const audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();
  const arrayBuffer = await webmBlob.arrayBuffer();
  const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
  
  // Extrair dados do canal (mono)
  const samples = audioBuffer.getChannelData(0);
  const sampleRate = audioBuffer.sampleRate;
  
  // Converter Float32Array para Int16Array
  const int16Array = new Int16Array(samples.length);
  for (let i = 0; i < samples.length; i++) {
    const s = Math.max(-1, Math.min(1, samples[i]));
    int16Array[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
  }
  
  // Encoder MP3
  const mp3encoder = new lamejs.Mp3Encoder(1, sampleRate, 128);
  const mp3Data: Int8Array[] = [];
  
  const sampleBlockSize = 1152;
  for (let i = 0; i < int16Array.length; i += sampleBlockSize) {
    const sampleChunk = int16Array.subarray(i, i + sampleBlockSize);
    const mp3buf = mp3encoder.encodeBuffer(sampleChunk);
    if (mp3buf.length > 0) {
      mp3Data.push(mp3buf);
    }
  }
  
  const mp3buf = mp3encoder.flush();
  if (mp3buf.length > 0) {
    mp3Data.push(mp3buf);
  }
  
  // Criar Blob MP3
  const mp3Blob = new Blob(mp3Data, { type: 'audio/mp3' });
  return mp3Blob;
}
```

---

## üéØ SOLU√á√ÉO MAIS SIMPLES: GRAVAR DIRETO EM OGG

Ao inv√©s de converter, grave o √°udio **direto em OGG**!

### **C√≥digo para grava√ß√£o em OGG:**

```typescript
// src/components/MessageInput.tsx

const startRecording = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
    // IMPORTANTE: Especificar mimeType como OGG
    const options = {
      mimeType: 'audio/ogg; codecs=opus' // Formato preferido do WhatsApp
    };
    
    // Fallback para navegadores que n√£o suportam OGG
    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
      options.mimeType = 'audio/webm; codecs=opus';
      console.warn('OGG n√£o suportado, usando WebM');
    }
    
    const recorder = new MediaRecorder(stream, options);
    const chunks: Blob[] = [];
    
    recorder.ondataavailable = (e) => {
      if (e.data.size > 0) {
        chunks.push(e.data);
      }
    };
    
    recorder.onstop = async () => {
      let audioBlob = new Blob(chunks, { type: recorder.mimeType });
      
      // Se gravou em WebM, mostrar warning
      if (recorder.mimeType.includes('webm')) {
        console.warn('‚ö†Ô∏è √Åudio gravado em WebM - pode n√£o funcionar no WhatsApp');
        // Aqui voc√™ pode converter ou avisar o usu√°rio
      }
      
      setAudioBlob(audioBlob);
      setAudioUrl(URL.createObjectURL(audioBlob));
      
      // Parar stream
      stream.getTracks().forEach(track => track.stop());
    };
    
    recorder.start();
    mediaRecorderRef.current = recorder;
    setRecordingState('recording');
    
  } catch (error) {
    console.error('Erro ao acessar microfone:', error);
    alert('Erro ao acessar o microfone');
  }
};
```

---

## üîß VERIFICAR COMPATIBILIDADE DO NAVEGADOR

```typescript
// Adicionar ao componente
useEffect(() => {
  const checkAudioSupport = () => {
    const types = [
      'audio/ogg; codecs=opus',
      'audio/webm; codecs=opus',
      'audio/mp4'
    ];
    
    console.log('Formatos de √°udio suportados:');
    types.forEach(type => {
      const supported = MediaRecorder.isTypeSupported(type);
      console.log(`${type}: ${supported ? '‚úÖ' : '‚ùå'}`);
    });
  };
  
  checkAudioSupport();
}, []);
```

---

## üìã EXTENS√ïES CORRETAS POR TIPO

Ao salvar no Supabase Storage, use a extens√£o correta:

```typescript
const getFileExtension = (mimeType: string, tipo: string): string => {
  const extensionMap: Record<string, string> = {
    // Imagens
    'image/jpeg': 'jpg',
    'image/png': 'png',
    'image/webp': 'webp',
    
    // V√≠deos
    'video/mp4': 'mp4',
    'video/3gpp': '3gp',
    
    // √Åudios
    'audio/ogg': 'ogg',           // ‚úÖ Preferido
    'audio/mpeg': 'mp3',          // ‚úÖ Aceito
    'audio/mp4': 'm4a',           // ‚úÖ Aceito
    'audio/amr': 'amr',           // ‚úÖ Aceito
    'audio/webm': 'webm',         // ‚ö†Ô∏è Pode n√£o funcionar
    
    // Documentos
    'application/pdf': 'pdf',
    'application/msword': 'doc',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',
    'application/vnd.ms-excel': 'xls',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'xlsx'
  };
  
  return extensionMap[mimeType] || 'bin';
};

// Ao fazer upload
const fileName = `${conversaId}/${Date.now()}_audio.${getFileExtension(audioBlob.type, 'audio')}`;
```

---

## üéØ RESUMO - O QUE FAZER:

### **OP√á√ÉO 1: Gravar direto em OGG (RECOMENDADO)**
```typescript
mimeType: 'audio/ogg; codecs=opus'
```
‚úÖ Formato nativo do WhatsApp
‚úÖ Sem convers√£o necess√°ria
‚úÖ Melhor qualidade

### **OP√á√ÉO 2: Converter WebM ‚Üí MP3**
```typescript
const mp3Blob = await convertWebMToMP3(webmBlob);
```
‚úÖ Compat√≠vel com WhatsApp
‚ö†Ô∏è Requer processamento extra
‚ö†Ô∏è Pode aumentar tamanho do arquivo

### **OP√á√ÉO 3: Aceitar upload de arquivos**
Permitir que o usu√°rio fa√ßa upload de arquivos de √°udio prontos (.mp3, .ogg)

---

## üöÄ C√ìDIGO COMPLETO PARA O REPLIT

Quer que eu te passe o **prompt completo** para ajustar o componente de grava√ß√£o de √°udio no Replit para gravar direto em OGG? 

**Responde "sim" e eu monto o prompt!** üé§‚ú®